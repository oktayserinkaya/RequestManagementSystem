@model WEB.Areas.PaymentTransaction.Models.PaymentTransactionVM.PaymentFormVM
@{
    ViewData["Title"] = "Ödeme Yap";
    string Safe(string? s) => string.IsNullOrWhiteSpace(s) ? "-" : s!;
}

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:300,400,500,600,700,900" />
<link id="pagestyle" href="~/TemplateResources/css/material-dashboard.css?v=3.2.0" rel="stylesheet" />

<div class="container mt-5">
    <div class="card shadow-lg">
        <div class="bg-gradient-dark shadow-dark border-radius-lg pt-4 pb-3 d-flex justify-content-between align-items-center px-3">
            <h6 class="text-white text-capitalize m-0">Ödeme Yap</h6>
            @if (!string.IsNullOrWhiteSpace(Model?.SpecPath))
            {
                <a class="btn btn-outline-light btn-sm"
                   asp-area="PaymentTransaction"
                   asp-controller="PaymentTransaction"
                   asp-action="Spec"
                   asp-route-id="@Model.RequestId"
                   target="_blank" rel="noopener noreferrer">
                    Şartnameyi Gör
                </a>
            }
        </div>

        <div class="card-body">

            @Html.ValidationSummary(false, "", new { @class = "text-danger mb-3" })

            <!-- Özet -->
            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <label class="form-label fw-bold">Talep No</label>
                    <input class="form-control border border-dark shadow-sm" value="@Model.RequestId" readonly />
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold">Talep Tarihi</label>
                    <input class="form-control border border-dark shadow-sm" value="@((Model.RequestDate ?? Model.CreatedDate).ToString("dd.MM.yyyy"))" readonly />
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold">Personel</label>
                    <input class="form-control border border-dark shadow-sm" value="@Safe(Model.EmployeeFullName)" readonly />
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold">Departman</label>
                    <input class="form-control border border-dark shadow-sm" value="@Safe(Model.DepartmentName)" readonly />
                </div>

                @* Ürün (Katalog) varsa göster *@
                @if (!string.IsNullOrWhiteSpace(Model?.ProductName) && Model.ProductName != "-")
                {
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Ürün (Katalog)</label>
                        <input class="form-control border border-dark shadow-sm" value="@Safe(Model.ProductName)" readonly />
                    </div>
                }

                @* Özel Ürün varsa göster, yoksa POST'a taşımak için hidden gönder *@
                @if (!string.IsNullOrWhiteSpace(Model?.SpecialProductName))
                {
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Özel Ürün</label>
                        <input asp-for="SpecialProductName" class="form-control border border-dark shadow-sm" readonly />
                    </div>
                }
                else
                {
                    <input type="hidden" asp-for="SpecialProductName" />
                }

                <div class="col-md-3">
                    <label class="form-label fw-bold">Talep Adedi</label>
                    <input class="form-control border border-dark shadow-sm" value="@(Model.RequestedAmount?.ToString() ?? "-")" readonly />
                </div>
            </div>

            <form method="post" asp-area="PaymentTransaction" asp-controller="PaymentTransaction" asp-action="Pay" asp-route-id="@Model.RequestId">
                @Html.AntiForgeryToken()
                <input type="hidden" asp-for="RequestId" />

                <div class="row g-4">
                    <!-- Satınalma Özeti (readonly) -->
                    <div class="col-lg-6">
                        <div class="card border h-100">
                            <div class="card-header bg-light"><strong>Satınalma Özeti</strong></div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Adet</label>
                                        <input class="form-control" value="@(Model.Quantity?.ToString() ?? "-")" readonly />
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Birim Fiyat</label>
                                        <input class="form-control" value="@(Model.UnitPrice?.ToString("0.##") ?? "-")" readonly />
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Para Birimi</label>
                                        <input class="form-control" value="@Model.Currency" readonly />
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">İskonto (%)</label>
                                        <input class="form-control" value="@Model.DiscountRate.ToString("0.##")" readonly />
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">KDV (%)</label>
                                        <input class="form-control" value="@Model.VatRate.ToString("0.##")" readonly />
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Genel Toplam</label>
                                        <input class="form-control fw-bold" value="@(Model.GrandTotal?.ToString("0.##") ?? "-")" readonly />
                                    </div>
                                </div>

                                <hr />
                                <div class="row g-3">
                                    <div class="col-sm-6">
                                        <label class="form-label">Ara Toplam</label>
                                        <input class="form-control" value="@(Model.Subtotal?.ToString("0.##") ?? "-")" readonly />
                                    </div>
                                    <div class="col-sm-6">
                                        <label class="form-label">İskonto Tutarı</label>
                                        <input class="form-control" value="@(Model.DiscountAmount?.ToString("0.##") ?? "-")" readonly />
                                    </div>
                                    <div class="col-sm-6">
                                        <label class="form-label">KDV Tutarı</label>
                                        <input class="form-control" value="@(Model.VatAmount?.ToString("0.##") ?? "-")" readonly />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tedarikçi Bilgileri (prefill, düzenlenebilir) -->
                    <div class="col-lg-6">
                        <div class="card border h-100">
                            <div class="card-header bg-light"><strong>Tedarikçi Bilgileri</strong></div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label asp-for="SupplierName" class="form-label">Tedarikçi Adı</label>
                                    <input asp-for="SupplierName" class="form-control" />
                                    <span asp-validation-for="SupplierName" class="text-danger"></span>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label asp-for="SupplierTaxNo" class="form-label">Vergi No</label>
                                        <input asp-for="SupplierTaxNo" class="form-control" />
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label asp-for="SupplierIban" class="form-label">IBAN</label>
                                        <input asp-for="SupplierIban" class="form-control" />
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label asp-for="SupplierEmail" class="form-label">E-Posta</label>
                                        <input asp-for="SupplierEmail" type="email" class="form-control" />
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label asp-for="SupplierPhone" class="form-label">Telefon</label>
                                        <input asp-for="SupplierPhone" class="form-control" />
                                    </div>
                                </div>

                                @* İsteğe bağlı meta *@
                                @if (!string.IsNullOrWhiteSpace(Model?.OfferNo) || Model?.OfferDate != null || !string.IsNullOrWhiteSpace(Model?.PaymentTerms))
                                {
                                    <hr />
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Teklif No</label>
                                            <input class="form-control" value="@Safe(Model?.OfferNo)" readonly />
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Teklif Tarihi</label>
                                            <input class="form-control" value="@(Model?.OfferDate?.ToString("dd.MM.yyyy") ?? "-")" readonly />
                                        </div>
                                        <div class="col-12 mb-3">
                                            <label class="form-label">Ödeme/Teslimat Şartları</label>
                                            <input class="form-control" value="@Safe(Model?.PaymentTerms)" readonly />
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>

                    <!-- Fatura / Ödeme -->
                    <div class="col-12">
                        <div class="card border h-100 mt-4">
                            <div class="card-header bg-light"><strong>Fatura / Ödeme</strong></div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3 mb-3">
                                        <label asp-for="InvoiceNo" class="form-label">Fatura No</label>
                                        <input asp-for="InvoiceNo" class="form-control" />
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label asp-for="InvoiceDate" class="form-label">Fatura Tarihi</label>
                                        <input asp-for="InvoiceDate" type="date" class="form-control" />
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label asp-for="PaymentMethod" class="form-label">Ödeme Yöntemi</label>
                                        <select asp-for="PaymentMethod" class="form-select">
                                            <option>EFT/Havale</option>
                                            <option>Kredi Kartı</option>
                                            <option>Nakit</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label asp-for="PaymentDate" class="form-label">Ödeme Tarihi</label>
                                        <input asp-for="PaymentDate" type="date" class="form-control" />
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-3 mb-3">
                                        <label asp-for="PaymentAmount" class="form-label">Ödeme Tutarı</label>
                                        <input asp-for="PaymentAmount" type="number" step="0.01" min="0" class="form-control" />
                                        <span asp-validation-for="PaymentAmount" class="text-danger"></span>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label class="form-label">Para Birimi</label>
                                        <input class="form-control" value="@Model.Currency" readonly />
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label asp-for="Notes" class="form-label">Notlar</label>
                                        <textarea asp-for="Notes" rows="2" class="form-control"></textarea>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>

                </div>

                <div class="d-flex justify-content-between align-items-center mt-4">
                    <a asp-area="PaymentTransaction" asp-controller="PaymentTransaction" asp-action="Index" class="btn btn-outline-secondary">← Listeye Dön</a>
                    <button type="submit" class="btn btn-primary">Ödemeyi Kaydet & PDF İndir</button>
                </div>
            </form>
        </div>
    </div>
</div>
