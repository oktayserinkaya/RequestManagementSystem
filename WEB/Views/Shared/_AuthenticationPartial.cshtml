@* Views/Shared/_AuthenticationPartial.cshtml *@
@using System
@using System.Linq

@{
    var area = ViewContext.RouteData.Values["area"]?.ToString();
    var controller = ViewContext.RouteData.Values["controller"]?.ToString();
    var action = ViewContext.RouteData.Values["action"]?.ToString();

    Func<string?, string?, string?, bool> isHere = (a, c, act) =>
        (a == null || string.Equals(area, a, StringComparison.OrdinalIgnoreCase)) &&
        (c == null || string.Equals(controller, c, StringComparison.OrdinalIgnoreCase)) &&
        (act == null || string.Equals(action, act, StringComparison.OrdinalIgnoreCase));

    Func<string?, string?, string?, string> active = (a, c, act) => isHere(a, c, act) ? " active" : "";

    // Alt menüyü açık tutma durumları
    bool inRequest = isHere("Request", "Requests", null);
    bool inCommission = isHere("RequestEvaluation", "RequestEvaluation", null);

    // Rol bayrakları
    bool isAdmin = User.IsInRole("Admin");
    bool isCommissionR = User.IsInRole("IhtiyacTespitKomisyonu");
    bool isRequester = User.IsInRole("TalepOluşturanBirim");  // <-- DÜZELTİLDİ (Türkçe karakterli)
    bool isProcurement = User.IsInRole("SatinAlmaBirimi");
    bool isWarehouse = User.IsInRole("DepoBirimi");
    bool isFinance = User.IsInRole("OdemeBirimi");

    // Sadece komisyon rolü (başka hiçbir rol yok) ve admin değil
    bool commissionOnly = isCommissionR && !(isAdmin || isRequester || isProcurement || isWarehouse || isFinance);
}

@if (User.Identity?.IsAuthenticated != true)
{
    <ul class="navbar-nav">
        <li class="nav-item">
            <a class="nav-link text-white@(active(null, "Account", "Login"))" asp-area="" asp-controller="Account" asp-action="Login">
                <i class="material-symbols-rounded me-2">login</i> Giriş Yap
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link text-white@(active(null, "Account", "Register"))" asp-area="" asp-controller="Account" asp-action="Register">
                <i class="material-symbols-rounded me-2">person_add</i> Kayıt Ol
            </a>
        </li>
    </ul>
}
else if (commissionOnly)
{
    @* Yalnızca "İhtiyaç Tespit Komisyonu" menüsü *@
    <ul class="navbar-nav">
        <li class="nav-item">
            <a class="nav-link text-white collapsed@(inCommission ? " active" : "")"
               data-bs-toggle="collapse" href="#commissionMenu"
               aria-expanded="@(inCommission.ToString().ToLower())" aria-controls="commissionMenu">
                <i class="material-symbols-rounded me-2">fact_check</i> İhtiyaç Tespit Komisyonu
            </a>
            <div class="collapse@(inCommission ? " show" : "")" id="commissionMenu">
                <ul class="nav flex-column ms-3">
                    <li class="nav-item">
                        <a href="@Url.Action("Index", "RequestEvaluation", new { area = "RequestEvaluation" })"
                           class="nav-link text-white@(active("RequestEvaluation", "RequestEvaluation", "Index"))">
                            <i class="material-symbols-rounded me-2">assignment</i> İncelenecek Talepler
                        </a>
                    </li>
                </ul>
            </div>
        </li>
    </ul>
}
else
{
    @* Diğer roller için tam menü *@
    <ul class="navbar-nav">

        <!-- Anasayfa -->
        <li class="nav-item">
            <a class="nav-link text-white@(active(null, "Home", "Index"))"
               asp-area="" asp-controller="Home" asp-action="Index">
                <i class="material-symbols-rounded me-2">dashboard</i> Anasayfa
            </a>
        </li>

        <!-- Talepler -->
        @if (isAdmin || isRequester || isProcurement || isWarehouse || isFinance)
        {
            <li class="nav-item">
                <a class="nav-link text-white@(active("Request", "Requests", "Index"))"
                   asp-area="Request" asp-controller="Requests" asp-action="Index">
                    <i class="material-symbols-rounded me-2">view_list</i> Tüm Talepler
                </a>
            </li>

            @* Talep Oluştur ve Taleplerim sadece TalepOluşturanBirim (ve Admin) için *@
            @if (isRequester || isAdmin)
            {
                <li class="nav-item">
                    <a class="nav-link text-white@(active("Request", "Requests", "CreateRequest"))"
                       asp-area="Request" asp-controller="Requests" asp-action="CreateRequest">
                        <i class="material-symbols-rounded me-2">add_circle</i> Talep Oluştur
                    </a>
                </li>
            }
        }

        <!-- İhtiyaç Tespit Komisyonu -->
        @if (isCommissionR || isAdmin)
        {
            <li class="nav-item">
                <a class="nav-link text-white collapsed@(inCommission ? " active" : "")"
                   data-bs-toggle="collapse" href="#commissionMenu"
                   aria-expanded="@(inCommission.ToString().ToLower())" aria-controls="commissionMenu">
                    <i class="material-symbols-rounded me-2">fact_check</i> İhtiyaç Tespit Komisyonu
                </a>
                <div class="collapse@(inCommission ? " show" : "")" id="commissionMenu">
                    <ul class="nav flex-column ms-3">
                        <li class="nav-item">
                            <a class="nav-link text-white@(active("RequestEvaluation", "RequestEvaluation", "Index"))"
                               asp-area="RequestEvaluation" asp-controller="RequestEvaluation" asp-action="Index">
                                <i class="material-symbols-rounded me-2">assignment</i> İncelenecek Talepler
                            </a>
                        </li>
                    </ul>
                </div>
            </li>
        }

        <!-- Satın Alma -->
        @if (isProcurement || isAdmin)
        {
            <li class="nav-item">
                <a class="nav-link text-white@(active("PurchaseTransaction", "Orders", "Index"))"
                   asp-area="PurchaseTransaction" asp-controller="Orders" asp-action="Index">
                    <i class="material-symbols-rounded me-2">shopping_cart</i> Satın Alma
                </a>
            </li>
        }

        <!-- Depo -->
        @if (isWarehouse || isAdmin)
        {
            <li class="nav-item">
                <a class="nav-link text-white@(active("Warehouse", "Stock", "Index"))"
                   asp-area="Warehouse" asp-controller="Stock" asp-action="Index">
                    <i class="material-symbols-rounded me-2">inventory_2</i> Depo
                </a>
            </li>
        }

        @if (isFinance || isAdmin)
        {
            <li class="nav-item">
                <a class="nav-link text-white@(active("PaymentTransaction", "PaymentTransaction", "Index"))"
                   href="~/Finance/Payments">
                    <i class="material-symbols-rounded me-2">payments</i> Ödeme Birimi
                </a>
            </li>
        }

        <li><hr class="horizontal light my-2" /></li>
        <li class="nav-item text-uppercase text-xs text-white-50 px-3">HESAPLAR</li>

        <!-- Kullanıcılar/Roller -->
        @if (isAdmin)
        {
            <li class="nav-item">
                <a class="nav-link text-white@(active("Admin", "Users", "Index"))"
                   asp-area="Admin" asp-controller="Users" asp-action="Index">
                    <i class="material-symbols-rounded me-2">group</i> Kullanıcılar/Roller
                </a>
            </li>
        }

        <!-- Ayarlar -->
        <li class="nav-item">
            <a class="nav-link text-white@(active(null, "Account", "Settings"))"
               asp-area="" asp-controller="Account" asp-action="Settings">
                <i class="material-symbols-rounded me-2">settings</i> Ayarlar
            </a>
        </li>
    </ul>
}
